<%@ page language="java" pageEncoding="UTF-8"%>
<%
	String contextPath = request.getContextPath();
	String pcName = request.getServerName();
	String OperatorID = (String)session.getAttribute("OperatorID");
	if(OperatorID==null){
		OperatorID = "00002";
	}
%>
<!DOCTYPE html>
<html>
	<head>
		 
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css">
		<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
		
		<!-- 
		<link rel="stylesheet" href="jquery.mobile-1.4.5/jquery.mobile.structure-1.4.5.min.css">
		<link rel="stylesheet" href="jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.css">
		<script src="js/jquery-1.8.3.min.js"></script>
		<script src="js/jquery.mobile-1.4.5.min.js"></script>
		 -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="js/tree.js"></script>
		<script src="js/json2.js"></script>
		<style type="text/css"></style>
		<title>销售订单</title>
	</head>

	<body>
		<div data-role="page" id="pageHome">
			<div data-role="content" data-theme="b">
				<form method="post">
					<div class="ui-field-contain">
						<label for="date">录单日期：</label>
						<input type="date" name="date" id="date"  data-clear-btn="true">
					</div>
					<div class="ui-field-contain">
						<label for="bianhao">单据编号：</label>
						<input type="text" name="bianhao" id="bianhao" readonly="readonly"  data-clear-btn="true">
					</div>
					<div class="ui-field-contain">
						<label for="jigou">机构：</label>
						<a id="jigouHref" href="#popupBasic" data-rel="popup" data-transition="pop" ><input readonly="readonly" type="text" name="jigou" orgCode="" id="jigou" data-clear-btn="true"></a><!-- href="#pageTree" -->
					</div>
					<div class="ui-field-contain">
						<label for="jingshouren">经手人：</label>
						<select name="jingshouren" id="jingshouren" ></select>
					</div>
					<div class="ui-field-contain">
						<label for="bumen">部门：</label>
						<select name="bumen" id="bumen" ></select>
					</div>
					<div class="ui-field-contain">
						<label for="kehu">客户：</label>
						<a id="kehuHref" href="#popupBasic" data-rel="popup" data-transition="pop" ><input readonly="readonly" type="text" name="kehu" id="kehu" data-clear-btn="true"></a>
					</div>
					<div class="ui-field-contain">
						<label for="fahuocangku">发货仓库：</label>
						<select name="fahuocangku" id="fahuocangku" ></select>
					</div>
					<div class="ui-field-contain">
						<label for="jiaohuoriqi">交货日期：</label>
						<input type="date" name="jiaohuoriqi" id="jiaohuoriqi" data-clear-btn="true">
					</div>
					<div class="ui-field-contain">
						<label for="fahuoleixing">发货类型：</label>
						<select name="fahuoleixing" id="fahuoleixing" ></select>
					</div>
					<br/>
					<br/>
					<br/>
					<div data-role="navbar">
						<ul><li><a href="#" class="ui-btn-active ui-state-persist">保存订单</a></li></ul>
					</div>
					<div data-role="popup" id="popupBasic" data-position-to="origin" data-theme="d" data-corners="false">
						<div data-role="content" data-theme="b">
							<a data-rel="back" data-role="button" data-icon="back">返回</a>
							<div id="orgTree" data-role="content">
								<div id="orgTreeListView" data-role="listview">
									<div id="returnParentDiv"><button class="ui-btn" data-inline="true">返回上一级</button></div>
									<div id="treeContainer"></div>
								</div>
							</div>
							<fieldset>
								<input type="text" name="choosedInfoLabel" id="choosedInfoLabel" data-clear-btn="true">
								<input type="hidden" name="choosedInfoValue" id="choosedInfoValue" data-clear-btn="true">
							</fieldset>
							<br>
							<a id="confirmOrgBtn" data-rel="back" data-role="button" data-icon="arrow-l">确定</a>
						</div>
					</div>
					<div data-role="popup" id="tipPop" data-position-to="window" data-theme="d" data-corners="false">
						<p></p>
					</div>
				</form>
			</div>
		</div>
	</body>

	<script type="text/javascript">
		var contextPath = "<%=contextPath%>";
		var cgddcode;
		var treeData = null;//机构数据
		var customerData = null;//客户数据
		var orgTreeObj;
		var popType=0;//用于区分当前弹出树组件的使用对象，0：默认未使用，1：机构，2：客户
		var goodsTypeData = null;//发货类型
		$(function(){
			//选择日期后触发
			$("#date").on('input',function(e){  
				var date = $("#date").val();
				if(date.length>0){
					sendForCGDD();
				}
			}); 
			
			//生成机构
			$("#jigouHref").bind("click",function(){
				popType = 1;
				sendForOrganization();
			});
			
			//生成客户
			$("#kehuHref").bind("click",function(){
				popType = 2;
				sendForCustomer();
			});
			
			//返回机构，客户的选择值
			$("#confirmOrgBtn").bind("click",function(){
				if(popType==1){
					var orgCode = $("#choosedInfoValue").val();
					var orgName =  $("#choosedInfoLabel").val();
					$("#jigou").val(orgName);
					$("#jigou").data("orgCode",orgCode);
					sendForBrokerage();
					sendForStoreHouse();
				}else if(popType==2){
					var customerCode = $("#choosedInfoValue").val();
					var customerName =  $("#choosedInfoLabel").val();
					$("#kehu").val(customerName);
					$("#kehu").data("orgCode",customerCode);
				}
				popType = 0;
			});
			
			//经手人选择后，选择部门
			$("#jingshouren").change(function (){ 
				sendForDept();
			}) ;
			
			//生成发货类型
			$("#jiaohuoriqi").change(function(){
				sendForGoodsType();
			}) ;
			
			
		});
		
		//请求后台生成订单编号
		function sendForCGDD(){
			var date = $("#date").val();
			if(date.length==0){
				return;
			}
			$.ajax({
				url: contextPath+"/BusinessServlet",
				data: "action=action_cgdd_code&date="+date+"&pcName=<%=pcName%>",
				type: "POST",
				dataType: 'text',
				timeout: 10000,
				async:false,
				error: function(XMLHttpRequest, textStatus, errorThrown){
					alert(XMLHttpRequest.status);
					alert(XMLHttpRequest.readyState);
					alert(textStatus);
				},
				success: function(data){
					var obj = JSON.parse(data);
					var result = obj.result;
					if(obj.isError=="true"){
						alert(result);
					}else{
						$("#bianhao").attr("value",result);
						$("#bianhao").attr("readonly",true);
					}
				}
		    });
		}
		
		//请求后台生成机构
		function sendForOrganization(){
			if(treeData!=null) {
				$("#treeContainer").empty();
				var obj = JSON.parse(treeData);
				orgTreeObj = new Tree("treeContainer","returnParentDiv","choosedInfoValue","choosedInfoLabel","BCtypeid","BCFullName");
				orgTreeObj.show(obj,true,null);
				return;
			}
			$.ajax({
				url: contextPath+"/BusinessServlet",
				data: "action=action_organization&OperatorID=<%=OperatorID%>&userType=23",
				type: "POST",
				dataType: 'text',
				timeout: 10000,
				async:false,
				error: function(XMLHttpRequest, textStatus, errorThrown){
					alert(XMLHttpRequest.status);
					alert(XMLHttpRequest.readyState);
					alert(textStatus);
				},
				success: function(data){
					var obj = JSON.parse(data);
					var result = obj.result;
					if(obj.isError=="true"){
						alert(result);
					}else{
						$("#treeContainer").empty();
						treeData = JSON.stringify(result);
						orgTreeObj = new Tree("treeContainer","returnParentDiv","choosedInfoValue","choosedInfoLabel","BCtypeid","BCFullName");
						orgTreeObj.show(result,true,null);
					}
				}
		    });
		}
		
		//请求后台生成经手人
		function sendForBrokerage(){
			var organization =  $("#jigou").data("orgCode");
			var that = this;
			$.ajax({
				url: contextPath+"/BusinessServlet",
				data: "action=action_brokerage&OperatorID=<%=OperatorID%>&organization="+organization,
				type: "POST",
				dataType: 'text',
				timeout: 10000,
				async:false,
				error: function(XMLHttpRequest, textStatus, errorThrown){
					alert(XMLHttpRequest.status);
					alert(XMLHttpRequest.readyState);
					alert(textStatus);
				},
				success: function(data){
					$("#jingshouren").empty();
					var obj = JSON.parse(data);
					var listArr = obj.result;
					if(obj.isError=="true"){
						alert(result);
					}else{
						var len = listArr.length;
						for(var i=0;i<len;i++){
							var dataObj = listArr[i];
							var currValue = dataObj.etypeid;
							var currText = dataObj.efullname;
							if(i==0){
								$("#jingshouren").append("<option selected value='"+currValue+"'>"+currText+"</option>");
							}else{
								$("#jingshouren").append("<option value='"+currValue+"'>"+currText+"</option>");
							}
						}
						$("#jingshouren").selectmenu('refresh', true);
						sendForDept();
					}
				}
		    });
		}
	
		// 请求部门
		function sendForDept(){
			var brokerage = $("#jingshouren").val();
			var organization =  $("#jigou").data("orgCode");
			$.ajax({
				url: contextPath+"/BusinessServlet",
				data: "action=action_department&BrokerageID="+brokerage+"&OperatorID=<%=OperatorID%>&organization="+organization,
				type: "POST",
				dataType: 'text',
				timeout: 10000,
				async:false,
				error: function(XMLHttpRequest, textStatus, errorThrown){
					alert(XMLHttpRequest.status);
					alert(XMLHttpRequest.readyState);
					alert(textStatus);
				},
				success: function(data){
					var obj = JSON.parse(data);
					var resultObj = obj.result;
					var infoArray = JSON.parse(resultObj.info);
					var defaultValueObj = JSON.parse(resultObj.default);
					if(obj.isError=="true"){
						alert(result);
					}else{
						var len = infoArray.length;
						for(var i=0;i<len;i++){
							var dataObj = infoArray[i];
							var currValue = dataObj.dtypeid;
							var currText = dataObj.dfullname;
							if(defaultValueObj.dtypeid == currValue){
								$("#bumen").append("<option selected value='"+currValue+"'>"+currText+"</option>");
							}else{
								$("#bumen").append("<option value='"+currValue+"'>"+currText+"</option>");
							}
						}
						$("#bumen").selectmenu('refresh', true);
					}
				}
		    });
		}
		
		//生成客户
		function sendForCustomer(){
			var organization =  $("#jigou").data("orgCode");
			if(organization.length==0){
				
			}
			if(customerData!=null) {
				$("#treeContainer").empty();
				var obj = JSON.parse(customerData);
				orgTreeObj = new Tree("treeContainer","returnParentDiv","choosedInfoValue","choosedInfoLabel","btypeid","bfullname");
				orgTreeObj.show(obj,true,null);
				return;
			}
			$.ajax({
				url: contextPath+"/BusinessServlet",
				data: "action=action_xsdd_customer&OperatorID=<%=OperatorID%>&organization="+organization,
				type: "POST",
				dataType: 'text',
				timeout: 10000,
				async:false,
				error: function(XMLHttpRequest, textStatus, errorThrown){
					alert(XMLHttpRequest.status);
					alert(XMLHttpRequest.readyState);
					alert(textStatus);
				},
				success: function(data){
					var obj = JSON.parse(data);
					var result = obj.result;
					if(obj.isError=="true"){
						alert(result);
					}else{
						$("#treeContainer").empty();
						customerData = JSON.stringify(result);
						orgTreeObj = new Tree("treeContainer","returnParentDiv","choosedInfoValue","choosedInfoLabel","btypeid","bfullname");
						orgTreeObj.show(result,true,null);
					}
				}
		    });
		}
		
		//生成仓库
		function sendForStoreHouse(){
			var organization =  $("#jigou").data("orgCode");
			if(organization.length==0){
				
			}
			$.ajax({
				url: contextPath+"/BusinessServlet",
				data: "action=action_xsdd_storehouse&OperatorID=<%=OperatorID%>&organization="+organization,
				type: "POST",
				dataType: 'text',
				timeout: 10000,
				async:false,
				error: function(XMLHttpRequest, textStatus, errorThrown){
					alert(XMLHttpRequest.status);
					alert(XMLHttpRequest.readyState);
					alert(textStatus);
				},
				success: function(data){
					var obj = JSON.parse(data);
					var resultObj = obj.result;
					var infoArray = JSON.parse(resultObj.info);
					var defaultValueObj = JSON.parse(resultObj.default);
					if(obj.isError=="true"){
						alert(result);
					}else{
						var len = infoArray.length;
						for(var i=0;i<len;i++){
							var dataObj = infoArray[i];
							var currValue = dataObj.typeID;
							var currText = dataObj.fullName;
							if(defaultValueObj.typeID == currValue){
								$("#fahuocangku").append("<option selected value='"+currValue+"'>"+currText+"</option>");
							}else{
								$("#fahuocangku").append("<option value='"+currValue+"'>"+currText+"</option>");
							}
						}
						$("#fahuocangku").selectmenu('refresh', true);
					}
				}
		    });
		}
		
		//选择发货类型
		function sendForGoodsType(){
			if(goodsTypeData!=null){
				return;
			}
			var organization =  $("#jigou").data("orgCode");
			if(organization.length==0){
				
			}
			$.ajax({
				url: contextPath+"/BusinessServlet",
				data: "action=action_xsdd_goodstype&organization="+organization,
				type: "POST",
				dataType: 'text',
				timeout: 10000,
				async:false,
				error: function(XMLHttpRequest, textStatus, errorThrown){
					alert(XMLHttpRequest.status);
					alert(XMLHttpRequest.readyState);
					alert(textStatus);
				},
				success: function(data){
					var obj = JSON.parse(data);
					var listArr = obj.result;
					goodsTypeData = listArr;
					if(obj.isError=="true"){
						alert(result);
					}else{
						var len = listArr.length;
						for(var i=0;i<len;i++){
							var dataObj = listArr[i];
							var currValue = dataObj.opID;
							var currText = dataObj.operName;
							if(i==0){
								$("#fahuoleixing").append("<option selected value='"+currValue+"'>"+currText+"</option>");
							}else{
								$("#fahuoleixing").append("<option value='"+currValue+"'>"+currText+"</option>");
							}
						}
						$("#fahuoleixing").selectmenu('refresh', true);
					}
				}
		    });
		}
		
		
		
	</script>

</html>
